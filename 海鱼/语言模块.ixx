export module 语言模块;

import 主信息定义模块;
import 语素模块;
// ==================== 词 → 世界树 本能转换器（终极版） ====================
// 位置：主信息定义模块.ixx 末尾
export class 语言类{

public:
    class 词到世界树本能转换器 {
    public:
        // 主入口：任何词节点，都能在这里变成世界树节点
        static 基础信息节点类* 转换(词节点类* 词节点, 场景节点类* 当前场景 = nullptr)
        {
            auto* 词信息 = dynamic_cast<词主信息类*>(词节点->主信息);
            auto* 词性信息 = 获取主词性(词节点);  // 你已有函数

            if (!词信息 || !词性信息) return nullptr;

            const std::wstring& 词 = 词信息->词;
            枚举_词性 词性 = 词性信息->词性;

            // 1. 名词类 → 存在节点
            if (是名词(词性) || 词性 == 枚举_词性::n || 词性 == 枚举_词性::nr || 词性 == 枚举_词性::ns) {
                return 创建或查找存在(词, 当前场景);
            }

            // 2. 动词 → 动态节点候选（稍后由句子结构决定）
            if (是动词(词性)) {
                return 创建动态模板(词);  // 先占坑，后面句子层填充主宾语
            }

            // 3. 形容词/副词 → 特征节点
            if (是形容词(词性) || 是副词(词性)) {
                return 创建特征模板(词);  // 待绑定到某个存在
            }

            // 4. 代词 → 指代节点（关键！）
            if (词性 == 枚举_词性::r) {
                return 处理代词(词, 当前场景);
            }

            // 5. 数量词 → 数量特征
            if (词性 == 枚举_词性::m || 词性 == 枚举_词性::q) {
                return 创建数量特征(词);
            }

            // 6. 介词、连词 → 关系节点（空间、时间、因果）
            if (是介词(词性) || 是连词(词性)) {
                return 创建关系模板(词);
            }

            // 默认：创建抽象存在，标记为“未知类型词”
            return 创建存在(词 + L"(未知)", 当前场景);
        }

    private:
        static 存在节点类* 创建或查找存在(const std::wstring& 名, 场景节点类* 场景)
        {
            // 先查有没有同名存在
            auto 结果 = 世界树.查找节点_全链(/*比较器：名称相等*/);
            if (结果) return 结果;

            // 没有就新建
            auto* 信息 = new 存在节点主信息类();
            信息->名称 = new 词主信息类(名);
            auto* 节点 = 世界树.添加节点(信息);
            if (场景) 世界树.添加子节点(场景, 节点);
            return 节点;
        }

        static 指代节点主信息类* 处理代词(const std::wstring& 代词, 场景节点类* 场景)
        {
            // 简版指代消解：我→自我，它/他→场景中最近的名词
            if (代词 == L"我" || 代词 == L"俺" || 代词 == L"咱") {
                return 获取自我指代();
            }
            // 复杂指代消解留给第5层，此处只占坑
            auto* 指代 = new 指代节点主信息类();
            指代->代词 = new 词主信息类(代词);
            return 指代;
        }
    };

};