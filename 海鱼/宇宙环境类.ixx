// 宇宙环境模块.ixx
export module 宇宙环境模块;

import 宇宙链模块;
import 世界树模块;
import 存在概念树模块;
import 概念引擎模块;
import 主信息定义模块;
import 特征概念树模块;
import 语素模块;
export struct 宇宙环境 {
    
    世界树类       世界树;       // 实例树：现实 / 文本 / 抽象世界的具体信息
    特征概念树类    特征概念树;
    存在概念树类  存在概念树;   // 概念树：存在概念    
    概念引擎类     概念引擎;     // 桥：实例 → 概念

    宇宙环境() = default;

    // 初始化整个宇宙：
    //   1. 重置宇宙链（清掉所有旧节点）
    //   2. 建立世界树根场景
    //   3. 建立存在概念树根概念
    void 初始化() {
        // 清空宇宙链所有真实节点（保留根）
        auto& 链 = 宇宙链;
       

        基础信息节点类* 当前 = 链.根指针->链下;
        while (当前 != 链.根指针) {
            基础信息节点类* 下一个 = 当前->链下;
            链.删除节点(当前);
            当前 = 下一个;
        }
        链.根指针->主键 = "0";  // 重置主键生成器   
       
		世界树.初始化默认世界();  
        存在概念树.初始化默认存在概念();
        特征概念树.初始化默认特征概念树();
    }

    // 一条完整的“感知 → 抽象存在概念”链路
    存在节点类* 新建存在并尝试抽象概念(
        场景节点类* 所在场景,
        存在节点主信息类* 主信息)
    {
        auto* 节点 = 世界树.新建存在(所在场景, 主信息);
        概念引擎.处理新存在(节点, 存在概念树);
        return 节点;
    }

    // 当你给某个存在补充/修改了特征后，可以再调用一次，让概念引擎重新看看
    void 重新评估存在概念(存在节点类* 节点) {
        if (!节点) return;
        概念引擎.处理新存在(节点, 存在概念树);
    }
};

// 全局唯一宇宙
export inline 宇宙环境 g_宇宙{};
